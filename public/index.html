<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="dark light" />
    <title>Stereo Verify</title>
  </head>

  <body onload="loadImage()" style="margin: 0;">
    <div style="display: flex; justify-content: center; flex-direction: column; min-height: 100vh; align-items: center">
      <h1>Stereo Verify</h1>
      <div id="loading" style="display: none; margin-bottom: 20px">loading...</div>
      <div id="error" style="display: none; color: red; margin-bottom: 20px"></div>
      <img id="image" style="max-width: 100%; max-height: 50vh; border: 1px solid #ccc; margin-bottom: 20px" />

      <div style="display: flex; align-items: center; gap: 15px; min-width: 300px">
        <button onclick="loadImage()" style="padding: 10px 20px; font-size: 16px; width: 100px">refresh</button>
        <input
          id="codeInput"
          type="text"
          placeholder="valid code"
          style="padding: 10px; font-size: 18px; text-align: center; width: 300px; box-sizing: border-box; text-transform: uppercase"
          maxlength="4"
          onkeypress="handleKeyPress(event)"
        />
        <button onclick="verifyCode()" style="padding: 10px 30px; font-size: 16px; cursor: pointer; width: 100px">verify</button>
      </div>
      <div id="verifyResult" style="min-height: 30px; margin-top: 10px"></div>
    </div>

    <div style="position: absolute; top: 0; right: 0; z-index: 1; margin: 10px">
      <a id="logo" href="https://github.com/geoochi/stereo-verify" target="_blank">
        <img src="/github.png" style="width: 50px"/>
      </a>
    </div>
  </body>

  <script>
    let currentToken = null

    async function loadImage() {
      const loadingEl = document.getElementById('loading')
      const errorEl = document.getElementById('error')
      const imageEl = document.getElementById('image')
      const codeInput = document.getElementById('codeInput')
      const verifyResult = document.getElementById('verifyResult')

      // Display loading state
      loadingEl.style.display = 'block'
      errorEl.style.display = 'none'
      imageEl.style.display = 'none'
      codeInput.value = ''
      verifyResult.innerHTML = ''
      currentToken = null

      try {
        // Get data from API
        const response = await fetch('/api/generate')
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        const data = await response.json()

        currentToken = data.token
        imageEl.src = data.dataURL
        imageEl.style.display = 'block'
        loadingEl.style.display = 'none'
        codeInput.focus()
      } catch (error) {
        console.error('Error loading image:', error)
        errorEl.textContent = `Error: ${error.message}`
        errorEl.style.display = 'block'
        loadingEl.style.display = 'none'
      }
    }

    async function verifyCode() {
      const codeInput = document.getElementById('codeInput')
      const verifyResult = document.getElementById('verifyResult')
      const code = codeInput.value.trim().toUpperCase()

      if (!code) {
        verifyResult.innerHTML = '<div style="color: red">Please input valid code</div>'
        return
      }

      if (!currentToken) {
        verifyResult.innerHTML = '<div style="color: red">Please load valid first</div>'
        return
      }

      verifyResult.innerHTML = '<div>verifying...</div>'

      try {
        const response = await fetch('/api/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ token: currentToken, code }),
        })

        const data = await response.json()

        if (data.success) {
          verifyResult.innerHTML = '<div style="color: green; font-size: 18px; font-weight: bold">âœ“ Success!</div>'
        } else {
          verifyResult.innerHTML = `<div style="color: red">${data.error || 'Failed'}</div>`
        }
      } catch (error) {
        console.error('Error verifying code:', error)
        verifyResult.innerHTML = `<div style="color: red">Verify error: ${error.message}</div>`
      }
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        verifyCode()
      }
    }
  </script>
</html>
