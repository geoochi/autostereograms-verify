<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>验证码验证</title>
  </head>

  <body onload="loadImage()" style="margin: 0; padding: 20px">
    <div style="display: flex; justify-content: center; flex-direction: column; min-height: 100vh; align-items: center">
      <h1>验证码验证</h1>
      <button onclick="loadImage()" style="margin-bottom: 20px; padding: 10px 20px; font-size: 16px">刷新验证码</button>
      <div id="loading" style="display: none; margin-bottom: 20px">加载中...</div>
      <div id="error" style="display: none; color: red; margin-bottom: 20px"></div>
      <img id="image" style="max-width: 100%; max-height: 50vh; border: 1px solid #ccc; margin-bottom: 20px" />
      
      <div style="display: flex; flex-direction: column; align-items: center; gap: 15px; min-width: 300px">
        <input
          id="codeInput"
          type="text"
          placeholder="请输入验证码"
          style="padding: 10px; font-size: 18px; text-align: center; width: 100%; box-sizing: border-box; text-transform: uppercase"
          maxlength="4"
          onkeypress="handleKeyPress(event)"
        />
        <button onclick="verifyCode()" style="padding: 10px 30px; font-size: 16px; cursor: pointer">验证</button>
        <div id="verifyResult" style="min-height: 30px; margin-top: 10px"></div>
      </div>
    </div>

    <script>
      let currentToken = null

      async function loadImage() {
        const loadingEl = document.getElementById('loading')
        const errorEl = document.getElementById('error')
        const imageEl = document.getElementById('image')
        const codeInput = document.getElementById('codeInput')
        const verifyResult = document.getElementById('verifyResult')

        // 显示加载状态
        loadingEl.style.display = 'block'
        errorEl.style.display = 'none'
        imageEl.style.display = 'none'
        codeInput.value = ''
        verifyResult.innerHTML = ''
        currentToken = null

        try {
          // 从 API 获取数据
          const response = await fetch('/api/generate')
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`)
          }
          const data = await response.json()

          currentToken = data.token
          imageEl.src = data.dataURL
          imageEl.style.display = 'block'
          loadingEl.style.display = 'none'
          codeInput.focus()
        } catch (error) {
          console.error('Error loading image:', error)
          errorEl.textContent = `错误: ${error.message}`
          errorEl.style.display = 'block'
          loadingEl.style.display = 'none'
        }
      }

      async function verifyCode() {
        const codeInput = document.getElementById('codeInput')
        const verifyResult = document.getElementById('verifyResult')
        const code = codeInput.value.trim().toUpperCase()

        if (!code) {
          verifyResult.innerHTML = '<div style="color: red">请输入验证码</div>'
          return
        }

        if (!currentToken) {
          verifyResult.innerHTML = '<div style="color: red">请先加载验证码</div>'
          return
        }

        verifyResult.innerHTML = '<div>验证中...</div>'

        try {
          const response = await fetch('/api/verify', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ token: currentToken, code }),
          })

          const data = await response.json()

          if (data.success) {
            verifyResult.innerHTML = '<div style="color: green; font-size: 18px; font-weight: bold">✓ 验证成功！</div>'
          } else {
            verifyResult.innerHTML = `<div style="color: red">${data.error || '验证失败'}</div>`
          }
        } catch (error) {
          console.error('Error verifying code:', error)
          verifyResult.innerHTML = `<div style="color: red">验证出错: ${error.message}</div>`
        }
      }

      function handleKeyPress(event) {
        if (event.key === 'Enter') {
          verifyCode()
        }
      }
    </script>
  </body>
</html>
